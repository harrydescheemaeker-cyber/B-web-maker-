<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <title>AI Code Studio - Home</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs/editor/editor.main.css">
    <style>
        :root { --bg: #1e1e1e; --nav: #2d2d2d; --accent: #007acc; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; height: 100vh; background: var(--bg); color: white; overflow: hidden; }
        
        /* Home Screen Style */
        #home-screen { position: fixed; inset: 0; background: var(--bg); z-index: 200; padding: 40px; overflow-y: auto; }
        .project-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
        .project-card { background: var(--nav); padding: 20px; border-radius: 8px; border: 1px solid #444; cursor: pointer; text-align: center; }
        .project-card:hover { border-color: var(--accent); }

        /* Editor Style */
        nav { background: var(--nav); padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #444; }
        #main { display: flex; flex: 1; height: calc(100vh - 60px); }
        #editor { width: 50%; height: 100%; }
        #preview-box { width: 50%; background: white; }
        iframe { width: 100%; height: 100%; border: none; }

        /* Popups */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 300; }
        .modal-content { background: #252526; padding: 25px; border-radius: 8px; width: 400px; text-align: center; }
        input { width: 80%; padding: 10px; margin: 10px 0; background: #3c3c3c; border: 1px solid #555; color: white; }
        button { cursor: pointer; padding: 10px 20px; border: none; border-radius: 4px; font-weight: bold; margin: 5px; }
        .btn-blue { background: var(--accent); color: white; }
        .btn-green { background: #27ae60; color: white; }
    </style>
</head>
<body>

<div id="home-screen">
    <h1>Mijn Projecten</h1>
    <button class="btn-blue" onclick="nieuwProject()">+ Nieuw Project</button>
    <div id="project-lijst" class="project-grid">
        </div>
</div>

<nav id="editor-nav" style="display:none">
    <div><button onclick="gaNaarHome()" style="background:none; color:#ccc">< Terug</button> | <strong id="project-titel">Naamloos</strong></div>
    <div>
        <button onclick="vraagAI()" style="background:#8e44ad; color:white">âœ¨ AI Tip</button>
        <button class="btn-green" onclick="saveProject()">Opslaan & Deel</button>
    </div>
</nav>

<div id="main" style="display:none">
    <div id="editor"></div>
    <div id="preview-box"><iframe id="preview"></iframe></div>
</div>

<div id="share-modal" class="modal">
    <div class="modal-content">
        <h3>Project Gepubliceerd!</h3>
        <p>Kopieer de link hieronder:</p>
        <input type="text" id="share-url" readonly onclick="this.select()">
        <br><br>
        <button class="btn-blue" onclick="document.getElementById('share-modal').style.display='none'">Sluiten</button>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs/loader.min.js"></script>
<script>
    const SUPABASE_URL = 'https://vqgimwgmhoxifzmsunxp.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZxZ2ltd2dtaG94aWZ6bXN1bnhwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3ODUzOTUsImV4cCI6MjA4NTM2MTM5NX0.rAcHlXDoVPmyw5LI3b7VeuDYQzFldZ5CA4_pBq1CO6c';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    let editor;
    let huidigProjectID = null;

    // 1. HOME SCHERM FUNCTIES
    async function laadProjecten() {
        const { data: { user } } = await sb.auth.getUser();
        if (!user) return; // Je moet ingelogd zijn (voeg evt login flow toe)

        const { data } = await sb.from('projecten').select('*').order('created_at', { ascending: false });
        const lijst = document.getElementById('project-lijst');
        lijst.innerHTML = '';
        
        data.forEach(p => {
            const card = document.createElement('div');
            card.className = 'project-card';
            card.innerHTML = `<h3>Project</h3><small>${new Date(p.created_at).toLocaleDateString()}</small>`;
            card.onclick = () => openProject(p);
            lijst.appendChild(card);
        });
    }

    function nieuwProject() {
        huidigProjectID = null;
        if(editor) editor.setValue("<h1>Nieuwe Website</h1>\n<p>Typ hier...</p>");
        toonEditor();
    }

    function openProject(p) {
        huidigProjectID = p.id;
        toonEditor();
        if(editor) editor.setValue(p.html_code);
    }

    function toonEditor() {
        document.getElementById('home-screen').style.display = 'none';
        document.getElementById('editor-nav').style.display = 'flex';
        document.getElementById('main').style.display = 'flex';
    }

    function gaNaarHome() {
        document.getElementById('home-screen').style.display = 'block';
        document.getElementById('editor-nav').style.display = 'none';
        document.getElementById('main').style.display = 'none';
        laadProjecten();
    }

    // 2. EDITOR INITIALISATIE
    require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs' }});
    require(['vs/editor/editor.main'], function() {
        editor = monaco.editor.create(document.getElementById('editor'), {
            value: "<h1>Hallo!</h1>",
            language: 'html',
            theme: 'vs-dark',
            automaticLayout: true
        });
        editor.onDidChangeModelContent(() => {
            document.getElementById('preview').srcdoc = editor.getValue();
        });
    });

    // 3. OPSLAAN & DELEN
    async function saveProject() {
        const { data: { user } } = await sb.auth.getUser();
        const code = editor.getValue();

        let res;
        if (huidigProjectID) {
            res = await sb.from('projecten').update({ html_code: code }).eq('id', huidigProjectID).select();
        } else {
            res = await sb.from('projecten').insert([{ html_code: code, user_id: user.id }]).select();
        }

        if (res.error) alert("Fout: " + res.error.message);
        else {
            huidigProjectID = res.data[0].id;
            const link = window.location.origin + window.location.pathname + "?id=" + huidigProjectID;
            document.getElementById('share-url').value = link;
            document.getElementById('share-modal').style.display = 'flex';
        }
    }

    function vraagAI() {
        const code = editor.getValue();
        if(!code.includes('<style>')) alert("AI Tip: Je website is nogal wit. Voeg een <style> tag toe voor wat kleur!");
        else if(!code.includes('button')) alert("AI Tip: Voeg een <button> toe om je site interactief te maken!");
        else alert("AI Tip: Ziet er goed uit! Probeer een Google Font toe te voegen voor een modernere look.");
    }

    // Start
    window.onload = async () => {
        const params = new URLSearchParams(window.location.search);
        if(params.get('id')) {
            // Als er een ID is, laad direct (voor bezoekers)
            const { data } = await sb.from('projecten').select('html_code').eq('id', params.get('id')).single();
            if(data) {
                document.body.innerHTML = data.html_code; // Toon ECHTE website aan bezoekers
                return;
            }
        }
        laadProjecten();
    };
</script>
</body>
</html>
